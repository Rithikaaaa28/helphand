{% extends "base.html" %}

{% block title %}View Task - HelpHand{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{{ url_for('main.dashboard') }}" class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
    </div>

    <!-- Task Details -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-start">
            <div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">{{ task.title }}</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">Posted on {{ task.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
            </div>
            <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full 
                {% if task.status == 'pending' %}bg-yellow-100 text-yellow-800
                {% elif task.status == 'assigned' %}bg-blue-100 text-blue-800
                {% elif task.status == 'completed' %}bg-green-100 text-green-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ task.status|title }}
            </span>
        </div>
        
        <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
            <dl class="sm:divide-y sm:divide-gray-200">
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Description</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ task.description }}</dd>
                </div>
                
                {% if task.category %}
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Category</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ task.category }}
                        </span>
                    </dd>
                </div>
                {% endif %}
                
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Location</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        {% if task.pincode %}
                            <i class="fas fa-map-marker-alt mr-1"></i>Pincode: {{ task.pincode }}
                        {% endif %}
                        {% if task.latitude and task.longitude %}
                            <br><i class="fas fa-globe mr-1"></i>GPS: {{ "%.4f, %.4f"|format(task.latitude, task.longitude) }}
                        {% endif %}
                    </dd>
                </div>
                
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Urgency</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                            {% if task.urgency == 'high' %}bg-red-100 text-red-800
                            {% elif task.urgency == 'medium' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ task.urgency|title }}
                        </span>
                    </dd>
                </div>
                
                {% if task.is_commercial %}
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Payment</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <span class="font-semibold text-green-600">₹{{ "%.2f"|format(task.payment_amount) }}</span>
                        <span class="text-xs text-gray-500 ml-2">(Platform fee: {{ "%.1f"|format(task.platform_fee * 100) }}%)</span>
                    </dd>
                </div>
                {% endif %}
                
                {% if task.assigned_volunteer %}
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Assigned Volunteer</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-2xl text-blue-500 mr-3"></i>
                            <div>
                                <div class="font-medium">{{ task.assigned_volunteer.user_profile.name }}</div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-star text-yellow-400"></i> 
                                    {{ "%.1f"|format(task.assigned_volunteer.rating) }} rating • 
                                    {{ task.assigned_volunteer.completed_tasks }} tasks completed
                                </div>
                            </div>
                        </div>
                    </dd>
                </div>
                {% endif %}
            </dl>
        </div>
    </div>

    <!-- AI-Matched Volunteers (if task is pending) -->
    {% if task.status == 'pending' and matched_volunteers %}
    <div class="mt-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-robot text-blue-600 mr-2"></i>AI-Matched Volunteers
        </h3>
        <p class="text-sm text-gray-600 mb-4">Our AI has found the best volunteers for your task based on skills, location, and experience.</p>
        
        <div class="space-y-4">
            {% for match in matched_volunteers %}
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-user-circle text-3xl text-blue-500 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-gray-900">{{ match.volunteer.user_profile.name }}</h4>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-star text-yellow-400"></i> 
                                    {{ "%.1f"|format(match.volunteer.rating) }} • 
                                    {{ match.volunteer.completed_tasks }} tasks
                                </div>
                            </div>
                        </div>
                        
                        <div class="ml-12">
                            <p class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-tools text-gray-400 mr-1"></i>
                                <strong>Skills:</strong> {{ match.volunteer.skills[:100] }}{% if match.volunteer.skills|length > 100 %}...{% endif %}
                            </p>
                            
                            <div class="flex flex-wrap gap-2 text-xs">
                                <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded">
                                    <i class="fas fa-brain mr-1"></i>
                                    Match: {{ "%.0f"|format(match.hybrid_score * 100) }}%
                                </span>
                                <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                    <i class="fas fa-puzzle-piece mr-1"></i>
                                    Skill: {{ "%.0f"|format(match.similarity_score * 100) }}%
                                </span>
                                <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    {% if match.distance_km and match.distance_km < 1000 %}
                                        {{ "%.1f"|format(match.distance_km) }} km away
                                    {% else %}
                                        Location not available
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ml-4">
                        <a href="{{ url_for('main.assign_task', task_id=task.id, volunteer_id=match.volunteer.id) }}" 
                           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                           onclick="return confirm('Assign this task to {{ match.volunteer.user_profile.name }}?')">
                            <i class="fas fa-user-check mr-2"></i>Assign
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% elif task.status == 'pending' %}
    <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
            <div>
                <h4 class="font-medium text-yellow-800">No Volunteers Found</h4>
                <p class="text-sm text-yellow-700 mt-1">We couldn't find any verified volunteers matching your task requirements at this time. Please check back later or try expanding your search criteria.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Task Actions -->
    {% if task.user_id == current_user.id %}
    <div class="mt-6 flex gap-4">
        {% if task.status == 'assigned' %}
        <form method="POST" action="{{ url_for('main.complete_task', task_id=task.id) }}" class="inline">
            <button type="submit" 
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"
                    onclick="return confirm('Mark this task as completed?')">
                <i class="fas fa-check-circle mr-2"></i>Mark as Completed
            </button>
        </form>
        {% endif %}
        
        {% if task.status == 'pending' %}
        <button type="button" 
                class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                onclick="alert('Edit functionality coming soon!')">
            <i class="fas fa-edit mr-2"></i>Edit Task
        </button>
        
        <button type="button" 
                class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50"
                onclick="if(confirm('Cancel this task?')) alert('Cancel functionality coming soon!')">
            <i class="fas fa-times-circle mr-2"></i>Cancel Task
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}